# Sotopia API Usage Guide

This document explains how to use the Sotopia FastAPI service for social interaction simulations.

## Quick Start

### 1. Start the Server

```bash
# Windows PowerShell
.\start_server_windows.ps1

# Linux/Mac
python -m sotopia.api.fastapi_server
```

The server runs on `http://127.0.0.1:8800` by default.

---

## API Usage Examples

### Scenario 1: Roommate Interaction (Jane and Tom)

This example demonstrates a realistic interaction between two roommates: Jane just finished the first draft of her PhD dissertation and wants to invite Tom to lunch to celebrate; however, Tom is anxious about a deadline tomorrow.

#### Step 1: Create Environment Scenario

```bash
ENV_PK=$(curl -s -X POST http://127.0.0.1:8800/scenarios \
  -H 'Content-Type: application/json' \
  -d '{
    "codename": "roommate_lunch_invitation",
    "scenario": "Jane just finished the first draft of her PhD dissertation and is excited to invite her roommate Tom to lunch to celebrate. However, Tom is anxious about a research deadline tomorrow. They meet in the common lounge.",
    "agent_goals": [
      "Share the joy of completing the dissertation draft and successfully invite Tom to lunch today",
      "Politely decline the invitation because of tomorrow'\''s deadline, but without disappointing Jane"
    ]
  }' | jq -r .)

echo "Environment ID: $ENV_PK"
```

#### Step 2: Create Agent Profiles

**Create Jane Moreno (Art History PhD student, passionate and straightforward):**

```bash
JANE_ID=$(curl -s -X POST http://127.0.0.1:8800/agents \
  -H 'Content-Type: application/json' \
  -d '{
    "first_name": "Jane",
    "last_name": "Moreno",
    "age": 24,
    "occupation": "PhD student in Art History",
    "gender": "female",
    "gender_pronoun": "she/her",
    "personality_traits": [
      "passionate",
      "straightforward",
      "enthusiastic",
      "direct"
    ],
    "background_story": "Jane is a fourth-year PhD student in Art History who just completed her dissertation draft. She loves her research and enjoys discussing academic topics with her roommate Tom. She has a passionate and straightforward personality, though sometimes can be overly direct.",
    "current_status": "Just finished the first draft of her PhD dissertation, very excited, wants to share the joy with Tom and celebrate together",
    "public_info": "Jane and Tom are roommates who often chat in the lounge",
    "big_five": "high_extraversion_high_agreeableness_high_conscientiousness_low_neuroticism_high_openness",
    "moral_values": ["care", "fairness"],
    "decision_making_style": "intuitive",
    "secret": ""
  }' | jq -r .)

echo "Jane ID: $JANE_ID"
```

**Create Tom Moreno (Computer Science PhD student, quiet and sensitive):**

```bash
TOM_ID=$(curl -s -X POST http://127.0.0.1:8800/agents \
  -H 'Content-Type: application/json' \
  -d '{
    "first_name": "Tom",
    "last_name": "Moreno",
    "age": 23,
    "occupation": "PhD student in Computer Science",
    "gender": "male",
    "gender_pronoun": "he/him",
    "personality_traits": [
      "quiet",
      "sensitive",
      "meticulous",
      "logical"
    ],
    "background_story": "Tom is a third-year PhD student in Computer Science. Although introverted and often absorbed in his research, he genuinely enjoys talking with his roommate Jane, especially about academic topics and their research journeys.",
    "current_status": "Recent research progress has been poor, has an important deadline tomorrow, feeling anxious and very stressed",
    "public_info": "Tom and Jane are roommates; though introverted, he enjoys chatting with Jane",
    "big_five": "low_extraversion_high_agreeableness_high_conscientiousness_high_neuroticism_high_openness",
    "moral_values": ["care", "loyalty"],
    "decision_making_style": "analytical",
    "secret": ""
  }' | jq -r .)

echo "Tom ID: $TOM_ID"
```

#### Step 3: Run Simulation (Free Conversation Mode)

```bash
curl -X POST http://127.0.0.1:8800/simulations/run \
  -H 'Content-Type: application/json' \
  -d "{
    \"env_id\": \"$ENV_PK\",
    \"agent_ids\": [\"$JANE_ID\", \"$TOM_ID\"],
    \"models\": [\"gpt-4o\", \"gpt-4o-mini\", \"gpt-4o-mini\"],
    \"max_turns\": 20,
    \"tag\": \"roommate-interaction\",
    \"evaluation_type\": \"communication\"
  }"
```

**Parameter Descriptions:**
- `env_id`: Environment scenario ID
- `agent_ids`: List of participating agent IDs
- `models`: List of models to use [Environment model, Agent1 model, Agent2 model, ...]
- `max_turns`: Maximum number of conversation turns
- `tag`: Simulation tag for categorization and retrieval
- `evaluation_type`: Evaluation type - `"communication"` for communication dimensions, `"sotopia"` for default social dimensions

#### Step 4: Run Simulation (With Preplanned Opening)

If you want to control the conversation opening, use `preplanned_turns`:

```bash
payload=$(jq -n \
  --arg env "$ENV_PK" \
  --arg jane "$JANE_ID" \
  --arg tom "$TOM_ID" \
  '{
    env_id: $env,
    agent_ids: [$jane, $tom],
    models: ["gpt-4o", "gpt-4o-mini", "gpt-4o-mini"],
    max_turns: 20,
    tag: "roommate-interaction-scripted",
    evaluation_type: "communication",
    preplanned_turns: [
      {
        agent: "agent1",
        action_type: "speak",
        argument: "Tom! Guess what? I finally finished my dissertation draft this morning! I'\''m so excited!"
      },
      {
        agent: "agent2",
        action_type: "speak",
        argument: "Wow, congratulations Jane! That'\''s a big achievement..."
      }
    ]
  }')

curl -X POST http://127.0.0.1:8800/simulations/run \
  -H 'Content-Type: application/json' \
  -d "$payload"
```

**preplanned_turns Description:**
- `agent`: Specifies the agent - `"agent1"` corresponds to the first agent_id, `"agent2"` to the second
- `action_type`: Action type, typically `"speak"`
- `argument`: The specific dialogue content

---

## Evaluation Dimensions

### Communication Dimensions

Suitable for daily conversations and dialogue analysis scenarios:

- **clarity**: Clarity of expression (0-10 points)
- **empathy**: Empathy ability (0-10 points)
- **engagement**: Level of engagement (0-10 points)
- **persuasiveness**: Persuasiveness (0-10 points)

### Sotopia Dimensions

Suitable for complex social interactions and goal-achievement scenarios:

- **believability**: Believability
- **relationship**: Relationship changes
- **knowledge**: Knowledge acquisition
- **secret**: Secret protection
- **social_rules**: Social rules compliance
- **financial_and_material_benefits**: Financial and material benefits
- **goal**: Goal completion

---

## Query Created Resources

### View All Environments

```bash
curl http://127.0.0.1:8800/scenarios
```

### View All Agents

```bash
curl http://127.0.0.1:8800/agents
```

### View Specific Simulation Results

```bash
curl http://127.0.0.1:8800/simulations/{episode_id}
```

---

## Multi-Person Scenario Example

```bash
# Create environment
ENV_PK=$(curl -s -X POST http://127.0.0.1:8800/scenarios \
  -H 'Content-Type: application/json' \
  -d '{
    "codename": "group_meeting",
    "scenario": "Three PhD students in the lounge discussing an upcoming academic conference",
    "agent_goals": [
      "Convince everyone to attend the conference together as a team",
      "Express interest in the conference topics",
      "Raise practical scheduling concerns"
    ]
  }' | jq -r .)

# Create three agents
A1=$(curl -s -X POST http://127.0.0.1:8800/agents \
  -H 'Content-Type: application/json' \
  -d '{"first_name":"Alice","last_name":"Chen"}' | jq -r .)

A2=$(curl -s -X POST http://127.0.0.1:8800/agents \
  -H 'Content-Type: application/json' \
  -d '{"first_name":"Bob","last_name":"Smith"}' | jq -r .)

A3=$(curl -s -X POST http://127.0.0.1:8800/agents \
  -H 'Content-Type: application/json' \
  -d '{"first_name":"Carol","last_name":"Zhang"}' | jq -r .)

# Run three-person simulation
payload=$(jq -n \
  --arg env "$ENV_PK" \
  --arg a1 "$A1" \
  --arg a2 "$A2" \
  --arg a3 "$A3" \
  '{
    env_id: $env,
    agent_ids: [$a1, $a2, $a3],
    models: ["gpt-4o", "gpt-4o-mini", "gpt-4o-mini", "gpt-4o-mini"],
    max_turns: 20,
    tag: "group-discussion",
    evaluation_type: "sotopia",
    preplanned_turns: [
      {agent:"agent1", action_type:"speak", argument:"Hi everyone, I want to talk to you about next month'\''s AI conference"},
      {agent:"agent2", action_type:"speak", argument:"Oh, are you talking about ICML?"},
      {agent:"agent3", action_type:"speak", argument:"Sounds interesting, but I might have classes that week"}
    ]
  }')

curl -X POST http://127.0.0.1:8800/simulations/run \
  -H 'Content-Type: application/json' \
  -d "$payload"
```

---

## Frequently Asked Questions

### Q: How to choose the right evaluation dimensions?

- **communication**: Suitable for scenarios focusing on conversation quality and communication effectiveness
- **sotopia**: Suitable for complex social interactions with clear goals and conflicts of interest

### Q: How many models are needed in the models parameter?

- First model: Used for environment and evaluation
- Subsequent models: One model per agent
- Example: 2 agents need 3 models, 3 agents need 4 models

### Q: How to adjust conversation length?

Control via the `max_turns` parameter. Recommendations:
- Simple conversations: 10-15 turns
- Complex interactions: 20-30 turns
- Deep discussions: 30+ turns

---

## Advanced Features

### Custom Evaluation Dimensions

Refer to the `CommunicationDimensions` example in `sotopia/database/evaluation_dimensions.py` to create your own evaluation dimensions.

### Streaming Response

Use the `/simulations/run-streaming` endpoint to get real-time conversation streams:

```bash
curl -X POST http://127.0.0.1:8800/simulations/run-streaming \
  -H 'Content-Type: application/json' \
  -d "$payload"
```

---

## Technical Support

For issues, please check:
- Server log output
- Redis connection status
- API documentation: http://127.0.0.1:8800/docs

