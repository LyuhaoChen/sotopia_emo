# Sotopia ä¸‰äººå¯¹è¯æ¨¡æ‹Ÿ - ä½¿ç”¨è¯´æ˜

## ğŸ“‹ ç›®å½•

1. [å‰ç½®å‡†å¤‡](#å‰ç½®å‡†å¤‡)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [è¯¦ç»†æ­¥éª¤](#è¯¦ç»†æ­¥éª¤)
4. [è„šæœ¬è¯´æ˜](#è„šæœ¬è¯´æ˜)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
6. [API ç«¯ç‚¹å‚è€ƒ](#api-ç«¯ç‚¹å‚è€ƒ)

---

## ğŸ”§ å‰ç½®å‡†å¤‡

### 1. å¯åŠ¨ Redis æœåŠ¡å™¨

```powershell
# æ–¹æ³• 1: ä½¿ç”¨ Docker
docker run -d -p 6379:6379 redis/redis-stack-server:latest

# æ–¹æ³• 2: æœ¬åœ°å®‰è£…ï¼ˆWindowsï¼‰
# ä¸‹è½½å¹¶å®‰è£… Redis for Windowsï¼Œç„¶åå¯åŠ¨æœåŠ¡
```

### 2. è®¾ç½®ç¯å¢ƒå˜é‡

```powershell
# è®¾ç½® OpenAI API Keyï¼ˆå¿…éœ€ï¼‰
$env:OPENAI_API_KEY = "sk-your-api-key-here"

# è®¾ç½® Redis è¿æ¥ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º localhostï¼‰
$env:REDIS_OM_URL = "redis://localhost:6379"
```

### 3. æ¿€æ´» Conda ç¯å¢ƒ

```powershell
conda activate sotopia
```

### 4. å¯åŠ¨ FastAPI æœåŠ¡å™¨

```powershell
# åœ¨ä¸€ä¸ªç»ˆç«¯çª—å£ä¸­è¿è¡Œ
fastapi run sotopia/api/fastapi_server.py --port 8800

# æˆ–è€…ä½¿ç”¨ uvicorn
uvicorn sotopia.api.fastapi_server:app --host 127.0.0.1 --port 8800
```

### 5. éªŒè¯æœåŠ¡å™¨è¿è¡Œ

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š
- **Health Check**: http://127.0.0.1:8800/health
- **API æ–‡æ¡£**: http://127.0.0.1:8800/docs

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³• 1: ä½¿ç”¨å®Œæ•´è„šæœ¬ï¼ˆæ¨èï¼‰

```powershell
# è¿è¡Œå®Œæ•´çš„æ¨¡æ‹Ÿæµç¨‹
.\run_sotopia_simulation.ps1
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- âœ… è‡ªåŠ¨æ£€æŸ¥ç¯å¢ƒ
- âœ… åˆ›å»ºåœºæ™¯å’Œ 3 ä¸ª Agents
- âœ… æäº¤æ¨¡æ‹Ÿè¯·æ±‚
- âœ… ç­‰å¾…å®Œæˆå¹¶æ˜¾ç¤ºç»“æœ
- âœ… è‡ªåŠ¨ä¿å­˜ JSON å’Œæ–‡æœ¬æ–‡ä»¶

### æ–¹æ³• 2: ä½¿ç”¨ç®€åŒ–è„šæœ¬

```powershell
# å¿«é€Ÿæµ‹è¯•ï¼ˆ5-8 è½®å¯¹è¯ï¼‰
.\run_simple_simulation.ps1
```

### æ–¹æ³• 3: è°ƒè¯•æ¨¡å¼

```powershell
# æ£€æŸ¥ API å’Œæ•°æ®çŠ¶æ€
.\debug_api.ps1
```

---

## ğŸ“ è¯¦ç»†æ­¥éª¤

### æ­¥éª¤ 0: ç¯å¢ƒæ£€æŸ¥

```powershell
# æ£€æŸ¥ API æœåŠ¡å™¨
Invoke-RestMethod -Uri "http://127.0.0.1:8800/health"

# æ£€æŸ¥ç¯å¢ƒå˜é‡
Write-Host "OpenAI Key: $env:OPENAI_API_KEY"
```

### æ­¥éª¤ 1: åˆ›å»ºåœºæ™¯ (Scenario)

```powershell
$scenarioBody = @{
    codename = "coffee_shop"
    scenario = "ä¸‰ä¸ªæœ‹å‹åœ¨å’–å•¡åº—ç›¸é‡"
    agent_goals = @(
        "åˆ†äº«å·¥ä½œè¿›å±•",
        "è¯¢é—® AI è¯é¢˜",
        "é‚€è¯·å‚åŠ æ´»åŠ¨"
    )
} | ConvertTo-Json

$ENV_PK = Invoke-RestMethod `
    -Uri "http://127.0.0.1:8800/scenarios" `
    -Method POST `
    -Headers @{"Content-Type"="application/json"} `
    -Body $scenarioBody

Write-Host "Scenario ID: $ENV_PK"
```

### æ­¥éª¤ 2: åˆ›å»º Agents

```powershell
# Agent 1
$agent1 = @{
    first_name = "Alice"
    last_name = "Johnson"
    age = 28
    occupation = "Software Engineer"
    gender = "female"
} | ConvertTo-Json

$A1 = Invoke-RestMethod `
    -Uri "http://127.0.0.1:8800/agents" `
    -Method POST `
    -Headers @{"Content-Type"="application/json"} `
    -Body $agent1

# Agent 2
$agent2 = @{
    first_name = "Bob"
    last_name = "Smith"
    age = 45
    occupation = "Professor"
    gender = "male"
} | ConvertTo-Json

$A2 = Invoke-RestMethod `
    -Uri "http://127.0.0.1:8800/agents" `
    -Method POST `
    -Headers @{"Content-Type"="application/json"} `
    -Body $agent2

# Agent 3
$agent3 = @{
    first_name = "Carol"
    last_name = "Williams"
    age = 32
    occupation = "Artist"
    gender = "female"
} | ConvertTo-Json

$A3 = Invoke-RestMethod `
    -Uri "http://127.0.0.1:8800/agents" `
    -Method POST `
    -Headers @{"Content-Type"="application/json"} `
    -Body $agent3

Write-Host "Agent IDs: $A1, $A2, $A3"
```

### æ­¥éª¤ 3: æäº¤æ¨¡æ‹Ÿ

```powershell
$simulationBody = @{
    env_id = $ENV_PK
    agent_ids = @($A1, $A2, $A3)
    models = @("gpt-4o-mini", "gpt-4o-mini", "gpt-4o-mini", "gpt-4o-mini")
    max_turns = 12
    tag = "my_simulation"
} | ConvertTo-Json

$EPISODE_PK = Invoke-RestMethod `
    -Uri "http://127.0.0.1:8800/simulate" `
    -Method POST `
    -Headers @{"Content-Type"="application/json"} `
    -Body $simulationBody

Write-Host "Episode ID: $EPISODE_PK"
```

### æ­¥éª¤ 4: æŸ¥è¯¢çŠ¶æ€

```powershell
# æŸ¥è¯¢ Episode è¯¦æƒ…
$episode = Invoke-RestMethod -Uri "http://127.0.0.1:8800/episodes/pk/$EPISODE_PK"

# æ£€æŸ¥æ¶ˆæ¯æ•°
$messageCount = if ($episode.messages) { $episode.messages.Count } else { 0 }
Write-Host "æ¶ˆæ¯æ•°: $messageCount"
```

### æ­¥éª¤ 5: ç­‰å¾…å®Œæˆ

```powershell
$maxWait = 120  # æœ€å¤šç­‰å¾… 2 åˆ†é’Ÿ
$elapsed = 0

while ($elapsed -lt $maxWait) {
    Start-Sleep -Seconds 5
    $elapsed += 5
    
    $ep = Invoke-RestMethod -Uri "http://127.0.0.1:8800/episodes/pk/$EPISODE_PK"
    $count = if ($ep.messages) { $ep.messages.Count } else { 0 }
    
    Write-Host "[$elapsed`s] æ¶ˆæ¯æ•°: $count"
    
    if ($count -ge 10) {
        Write-Host "å®Œæˆï¼"
        break
    }
}
```

### æ­¥éª¤ 6: è·å–ç»“æœ

```powershell
# è·å–å®Œæ•´ç»“æœ
$result = Invoke-RestMethod -Uri "http://127.0.0.1:8800/episodes/pk/$EPISODE_PK"

# æ˜¾ç¤ºå¯¹è¯
foreach ($msg in $result.messages) {
    $speaker = if ($msg.agent_name) { $msg.agent_name } else { "System" }
    $content = if ($msg.content) { $msg.content } else { $msg.message }
    Write-Host "[$speaker]: $content"
}

# ä¿å­˜åˆ°æ–‡ä»¶
$result | ConvertTo-Json -Depth 10 | Out-File "episode_result.json" -Encoding UTF8
```

---

## ğŸ“¦ è„šæœ¬è¯´æ˜

### 1. `run_sotopia_simulation.ps1` - å®Œæ•´ç‰ˆ

**åŠŸèƒ½**ï¼š
- å®Œæ•´çš„ 6 æ­¥æµç¨‹
- è¯¦ç»†çš„è¿›åº¦æ˜¾ç¤º
- è‡ªåŠ¨ä¿å­˜ JSON + TXT
- å½©è‰²è¾“å‡º
- é”™è¯¯å¤„ç†

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ­£å¼è¿è¡Œæ¨¡æ‹Ÿ
- éœ€è¦è¯¦ç»†æ—¥å¿—
- ç”Ÿäº§ç¯å¢ƒ

**è¿è¡Œæ—¶é—´**: 2-5 åˆ†é’Ÿ

---

### 2. `run_simple_simulation.ps1` - ç®€åŒ–ç‰ˆ

**åŠŸèƒ½**ï¼š
- å¿«é€Ÿæµ‹è¯•
- æœ€å°åŒ–è¾“å‡º
- 8 è½®å¯¹è¯

**ä½¿ç”¨åœºæ™¯**ï¼š
- å¿«é€Ÿæµ‹è¯• API
- éªŒè¯ç¯å¢ƒé…ç½®
- å¼€å‘è°ƒè¯•

**è¿è¡Œæ—¶é—´**: 1-2 åˆ†é’Ÿ

---

### 3. `debug_api.ps1` - è°ƒè¯•å·¥å…·

**åŠŸèƒ½**ï¼š
- å¥åº·æ£€æŸ¥
- æŸ¥çœ‹æ‰€æœ‰æ•°æ®
- æµ‹è¯•æ‰€æœ‰ç«¯ç‚¹
- ç¯å¢ƒå˜é‡æ£€æŸ¥
- æŸ¥çœ‹æœ€æ–° Episode

**ä½¿ç”¨åœºæ™¯**ï¼š
- API ä¸å·¥ä½œ
- æŸ¥çœ‹æ•°æ®åº“å†…å®¹
- è¯Šæ–­é—®é¢˜

**è¿è¡Œæ—¶é—´**: 10-20 ç§’

---

## â“ å¸¸è§é—®é¢˜

### Q1: æœåŠ¡å™¨è¿”å› "Connection refused"

**åŸå› **: FastAPI æœåŠ¡å™¨æ²¡æœ‰å¯åŠ¨

**è§£å†³**:
```powershell
# å¯åŠ¨æœåŠ¡å™¨
fastapi run sotopia/api/fastapi_server.py --port 8800
```

---

### Q2: æç¤º "OPENAI_API_KEY not found"

**åŸå› **: ç¯å¢ƒå˜é‡æœªè®¾ç½®

**è§£å†³**:
```powershell
# è®¾ç½® API Key
$env:OPENAI_API_KEY = "sk-your-key-here"

# éªŒè¯
Write-Host $env:OPENAI_API_KEY
```

---

### Q3: Redis è¿æ¥å¤±è´¥

**åŸå› **: Redis æœåŠ¡å™¨æ²¡æœ‰è¿è¡Œ

**è§£å†³**:
```powershell
# ä½¿ç”¨ Docker å¯åŠ¨ Redis
docker run -d -p 6379:6379 redis/redis-stack-server:latest

# éªŒè¯
redis-cli ping
# åº”è¯¥è¿”å› "PONG"
```

---

### Q4: æ¨¡æ‹Ÿä¸€ç›´ä¸å®Œæˆ

**å¯èƒ½åŸå› **:
1. OpenAI API å“åº”æ…¢
2. ç½‘ç»œé—®é¢˜
3. API é…é¢ç”¨å®Œ

**è§£å†³**:
```powershell
# æ£€æŸ¥æ¨¡æ‹ŸçŠ¶æ€
$ep = Invoke-RestMethod -Uri "http://127.0.0.1:8800/episodes/pk/$EPISODE_PK"
$ep | ConvertTo-Json -Depth 10

# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼ˆFastAPI ç»ˆç«¯çª—å£ï¼‰
```

---

### Q5: æ‰¾ä¸åˆ° Episode

**åŸå› **: `simulation_status` ç«¯ç‚¹æœ‰ bug

**è§£å†³**: ä½¿ç”¨ `episodes` ç«¯ç‚¹
```powershell
# âŒ å¯èƒ½å¤±è´¥
Invoke-RestMethod -Uri "http://127.0.0.1:8800/simulation_status/$EPK"

# âœ… æ¨èä½¿ç”¨
Invoke-RestMethod -Uri "http://127.0.0.1:8800/episodes/pk/$EPK"
```

---

### Q6: å¦‚ä½•æŸ¥çœ‹æ‰€æœ‰å†å²æ¨¡æ‹Ÿï¼Ÿ

```powershell
# æŸ¥çœ‹æ‰€æœ‰ Episodes
$all = Invoke-RestMethod -Uri "http://127.0.0.1:8800/episodes"

# æ˜¾ç¤ºæ‘˜è¦
$all | Format-Table pk, tag, @{Name="Messages";Expression={$_.messages.Count}} -AutoSize

# æŸ¥çœ‹ç‰¹å®š Episode
$ep = $all | Where-Object { $_.tag -eq "coffee_shop_conversation" }
$ep | ConvertTo-Json -Depth 10
```

---

## ğŸ”— API ç«¯ç‚¹å‚è€ƒ

### åŸºç¡€ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/health` | GET | å¥åº·æ£€æŸ¥ |
| `/models` | GET | å¯ç”¨æ¨¡å‹åˆ—è¡¨ |

### Scenarios (åœºæ™¯)

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/scenarios` | GET | è·å–æ‰€æœ‰åœºæ™¯ |
| `/scenarios/{get_by}/{value}` | GET | æŒ‰æ¡ä»¶æŸ¥è¯¢ |
| `/scenarios` | POST | åˆ›å»ºåœºæ™¯ |
| `/scenarios/{id}` | DELETE | åˆ é™¤åœºæ™¯ |

### Agents (è§’è‰²)

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/agents` | GET | è·å–æ‰€æœ‰ Agents |
| `/agents/{get_by}/{value}` | GET | æŒ‰æ¡ä»¶æŸ¥è¯¢ |
| `/agents` | POST | åˆ›å»º Agent |
| `/agents/{id}` | DELETE | åˆ é™¤ Agent |

### Episodes (å¯¹è¯è®°å½•)

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/episodes` | GET | è·å–æ‰€æœ‰ Episodes |
| `/episodes/{get_by}/{value}` | GET | æŒ‰æ¡ä»¶æŸ¥è¯¢ |
| `/episodes/{id}` | DELETE | åˆ é™¤ Episode |

### Simulation (æ¨¡æ‹Ÿ)

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/simulate` | POST | æäº¤æ¨¡æ‹Ÿä»»åŠ¡ |
| `/simulation_status/{id}` | GET | æŸ¥è¯¢çŠ¶æ€ï¼ˆæœ‰ bugï¼‰âš ï¸ |

---

## ğŸ“Š æ•°æ®ç»“æ„

### SimulationRequest

```json
{
  "env_id": "01JBXXXXXXXX",
  "agent_ids": ["01JBXX1", "01JBXX2", "01JBXX3"],
  "models": ["gpt-4o-mini", "gpt-4o-mini", "gpt-4o-mini", "gpt-4o-mini"],
  "max_turns": 12,
  "tag": "my_simulation"
}
```

**è¯´æ˜**:
- `env_id`: åœºæ™¯ ID
- `agent_ids`: å‚ä¸çš„ Agentsï¼ˆ3ä¸ªï¼‰
- `models`: æ¯ä¸ª Agent + 1 ä¸ªç¯å¢ƒæ¨¡å‹ï¼ˆ4ä¸ªï¼‰
- `max_turns`: æœ€å¤§å¯¹è¯è½®æ•°
- `tag`: æ ‡ç­¾ï¼ˆä¾¿äºæŸ¥æ‰¾ï¼‰

### AgentProfile

```json
{
  "first_name": "Alice",
  "last_name": "Johnson",
  "age": 28,
  "occupation": "Software Engineer",
  "gender": "female",
  "gender_pronoun": "she/her",
  "personality_traits": ["analytical", "friendly"],
  "public_info": "æè¿°ä¿¡æ¯",
  "big_five_personality": ["high_openness", "high_conscientiousness", ...]
}
```

### EnvironmentProfile (Scenario)

```json
{
  "codename": "coffee_shop",
  "scenario": "åœºæ™¯æè¿°",
  "agent_goals": [
    "ç›®æ ‡1",
    "ç›®æ ‡2",
    "ç›®æ ‡3"
  ]
}
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ¨¡å‹é€‰æ‹©

```powershell
# å¿«é€Ÿæµ‹è¯• - ä½¿ç”¨ gpt-4o-mini
models = @("gpt-4o-mini", "gpt-4o-mini", "gpt-4o-mini", "gpt-4o-mini")

# é«˜è´¨é‡å¯¹è¯ - ä½¿ç”¨ gpt-4o
models = @("gpt-4o", "gpt-4o", "gpt-4o", "gpt-4o")

# æ··åˆæ¨¡å¼
models = @("gpt-4o-mini", "gpt-4o", "gpt-4o-mini", "gpt-4o-mini")
```

### 2. å¯¹è¯è½®æ•°

- **æµ‹è¯•**: 4-8 è½®
- **æ¼”ç¤º**: 10-15 è½®
- **æ·±åº¦å¯¹è¯**: 20-30 è½®

### 3. åœºæ™¯è®¾è®¡

å¥½çš„åœºæ™¯åº”è¯¥ï¼š
- âœ… æ¸…æ™°çš„èƒŒæ™¯æè¿°
- âœ… æ˜ç¡®çš„ Agent ç›®æ ‡
- âœ… æœ‰å†²çªæˆ–äº’åŠ¨ç‚¹
- âœ… å¼€æ”¾å¼ç»“å±€

### 4. é”™è¯¯å¤„ç†

```powershell
try {
    $result = Invoke-RestMethod -Uri $url -Method POST -Body $body
} catch {
    Write-Host "é”™è¯¯: $($_.Exception.Message)" -ForegroundColor Red
    
    # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯
    if ($_.ErrorDetails.Message) {
        Write-Host $_.ErrorDetails.Message
    }
}
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… è¿è¡Œ `debug_api.ps1` æ£€æŸ¥ç¯å¢ƒ
2. âœ… è¿è¡Œ `run_simple_simulation.ps1` å¿«é€Ÿæµ‹è¯•
3. âœ… è¿è¡Œ `run_sotopia_simulation.ps1` å®Œæ•´æ¨¡æ‹Ÿ
4. ğŸ“ æŸ¥çœ‹ç”Ÿæˆçš„ JSON å’Œ TXT æ–‡ä»¶
5. ğŸ¨ è‡ªå®šä¹‰åœºæ™¯å’Œ Agents
6. ğŸš€ é›†æˆåˆ°æ‚¨çš„é¡¹ç›®ä¸­

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **API æ–‡æ¡£**: http://127.0.0.1:8800/docs
- **Health Check**: http://127.0.0.1:8800/health
- **GitHub**: [sotopia-org/sotopia](https://github.com/sotopia-org/sotopia)

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰**

